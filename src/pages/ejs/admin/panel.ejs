<!DOCTYPE html>
<html>
    <head>
        <title>Admin Panel - pissandshitimages</title>
        <style>
            body {
                font-family: 'Comic Sans MS', cursive, sans-serif;
                background: #f0f0f0;
                margin: 0;
                padding: 20px;
            }
            h1 {
                color: #ff6b6b;
                text-shadow: 2px 2px 0 #000;
                font-size: 2.5em;
                margin-bottom: 30px;
                text-align: center;
            }
            .browse-controls {
                background: white;
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 0 10px rgba(0,0,0,0.1);
                margin-bottom: 20px;
            }
            .browse-controls h3 {
                color: #ff6b6b;
                margin-top: 0;
                margin-bottom: 15px;
            }
            .control-row {
                display: flex;
                gap: 10px;
                align-items: center;
                flex-wrap: wrap;
                margin-bottom: 15px;
            }
            .control-group {
                display: flex;
                gap: 5px;
                align-items: center;
            }
            .control-group label {
                font-weight: bold;
                color: #333;
                white-space: nowrap;
            }
            .control-group select, .control-group input[type="text"] {
                padding: 8px;
                border: 2px solid #ff6b6b;
                border-radius: 5px;
                font-size: 14px;
            }
            .search-input {
                min-width: 200px;
            }
            .apply-btn {
                background: #ff6b6b;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 5px;
                cursor: pointer;
                font-weight: bold;
            }
            .apply-btn:hover {
                background: #ff5252;
            }
            .clear-btn {
                background: #ccc;
                color: #333;
                border: none;
                padding: 8px 16px;
                border-radius: 5px;
                cursor: pointer;
                text-decoration: none;
            }
            .clear-btn:hover {
                background: #bbb;
            }
            .active-filters {
                background: #f0f8ff;
                border: 2px solid #4ecdc4;
                border-radius: 8px;
                padding: 10px;
                margin-top: 10px;
            }
            .filter-tag {
                display: inline-block;
                background: #4ecdc4;
                color: white;
                padding: 4px 8px;
                border-radius: 12px;
                margin: 2px;
                font-size: 12px;
            }
            .checkbox-group {
                display: flex;
                gap: 10px;
                align-items: center;
            }
            .checkbox-group input[type="checkbox"] {
                margin-right: 5px;
            }
            .stats {
                background: white;
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 0 10px rgba(0,0,0,0.1);
                margin-bottom: 20px;
            }
            .image-list {
                background: white;
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 0 10px rgba(0,0,0,0.1);
            }
            table {
                width: 100%;
                border-collapse: collapse;
            }
            th, td {
                padding: 10px;
                border-bottom: 1px solid #ddd;
                text-align: left;
            }
            th {
                background: #ff6b6b;
                color: white;
            }
            tr:nth-child(even) {
                background: #f9f9f9;
            }
            .delete-btn {
                background: #ff4757;
                color: white;
                border: none;
                padding: 5px 10px;
                border-radius: 3px;
                cursor: pointer;
                margin-right: 5px;
            }
            .delete-btn:hover {
                background: #ff6b6b;
            }
            .delete-btn.nuclear {
                background: #8B0000;
                font-weight: bold;
            }
            .delete-btn.nuclear:hover {
                background: #A0000A;
            }
            .ban-btn {
                background: #ff6b6b;
                color: white;
                border: none;
                padding: 5px 10px;
                border-radius: 3px;
                cursor: pointer;
                margin-right: 5px;
            }
            .ban-btn:hover {
                background: #ff4757;
            }
            .ban-btn:disabled {
                background: #ccc;
                cursor: not-allowed;
            }
            .thumbnail {
                max-width: 100px;
                max-height: 100px;
                object-fit: cover;
                border-radius: 3px;
            }
            .pagination {
                margin-top: 20px;
                text-align: center;
            }
            .pagination a {
                display: inline-block;
                padding: 8px 16px;
                text-decoration: none;
                background-color: #ff6b6b;
                color: white;
                border-radius: 5px;
                margin: 0 5px;
            }
            .pagination a:hover {
                background-color: #ff5252;
            }
            .pagination .current {
                background-color: #ff5252;
                font-weight: bold;
            }
            .pagination .disabled {
                background-color: #cccccc;
                pointer-events: none;
            }
            .stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 20px;
                margin-top: 20px;
            }
            .stat-box {
                background: #fff;
                padding: 15px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .stat-box h3 {
                color: #ff6b6b;
                margin-top: 0;
                margin-bottom: 10px;
            }
            .shitlevel-badge {
                display: inline-block;
                padding: 5px 10px;
                border-radius: 15px;
                color: white;
                font-weight: bold;
            }
            .shitlevel-badge.lucky {
                background: #4CAF50;
            }
            .shitlevel-badge.extreme {
                background: #f44336;
            }
            .shitlevel-badge.normal {
                background: #ff9800;
            }
            .visibility-btn {
                padding: 5px 10px;
                border: none;
                border-radius: 3px;
                cursor: pointer;
                margin-right: 5px;
            }
            .visibility-btn.visible {
                background: #4CAF50;
                color: white;
            }
            .visibility-btn.hidden {
                background: #ff9800;
                color: white;
            }
            .visibility-btn:hover {
                opacity: 0.9;
            }
            .success-message {
                background: #4CAF50;
                color: white;
                padding: 15px;
                border-radius: 5px;
                margin-bottom: 20px;
                text-align: center;
            }
            .nav-links {
                text-align: center;
                margin-bottom: 20px;
            }
            .nav-links a {
                display: inline-block;
                background: #4ecdc4;
                color: white;
                text-decoration: none;
                padding: 10px 20px;
                border-radius: 5px;
                margin: 0 10px;
            }
            .nav-links a:hover {
                background: #45b7b0;
            }
            .ip-info {
                color: #666;
                font-size: 0.9em;
                font-family: monospace;
            }
            .management-section {
                margin-top: 20px;
                background: white;
                padding: 15px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .management-section h3 {
                color: #ff6b6b;
                margin-top: 0;
                margin-bottom: 10px;
            }
            .bulk-delete-section {
                background: #fff5f5;
                border: 2px solid #ff6b6b;
                border-radius: 8px;
                padding: 15px;
                margin-top: 20px;
            }
            .bulk-delete-section h3 {
                color: #8B0000;
                margin-top: 0;
                margin-bottom: 10px;
            }
            .warning-text {
                color: #666;
                margin-bottom: 15px;
                font-weight: bold;
            }
            .form-row {
                display: flex;
                gap: 10px;
                align-items: center;
            }
            .form-input {
                flex: 1;
                padding: 10px;
                border: 2px solid #ff6b6b;
                border-radius: 5px;
            }
            .bulk-delete-btn {
                padding: 10px 15px;
                background: #8B0000;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-weight: bold;
            }
            .bulk-delete-btn:hover {
                background: #A0000A;
            }
            @media (max-width: 768px) {
                .control-row {
                    flex-direction: column;
                    align-items: stretch;
                }
                .control-group {
                    flex-direction: column;
                    align-items: stretch;
                    gap: 5px;
                }
                .search-input {
                    min-width: auto;
                    width: 100%;
                }
            }
        </style>
    </head>
    <body>
        <script src="/oneko.js"></script>
        <h1>üõ†Ô∏è Admin Panel - pissandshitimages</h1>
        
        <div class="nav-links">
            <a href="/admin/banned-ips">üö´ View Banned IPs (<%= bannedIPsCount %>)</a>
            <a href="/admin/sessions">üîê Active Sessions</a>
            <a href="/admin/change-password">üîë Change Password</a>
            <a href="/gallery">üñºÔ∏è Gallery</a>
            <a href="/admin/logout">üö™ Logout</a>
        </div>
        
        <% if (bannedSuccess) { %>
            <div class="success-message">‚úÖ IP has been successfully banned!</div>
        <% } %>
        <% if (deletedSuccess) { %>
            <div class="success-message">‚úÖ Image has been successfully deleted!</div>
        <% } %>
        <% if (visibilitySuccess) { %>
            <div class="success-message">‚úÖ Image visibility has been successfully updated!</div>
        <% } %>
        <% if (typeof query !== 'undefined' && query.bulk_deleted) { %>
            <div class="success-message">üî• Successfully deleted <%= query.bulk_deleted %> images and banned the associated IP!</div>
        <% } %>
        <% if (typeof query !== 'undefined' && query.deleted_count) { %>
            <div class="success-message">üî• Successfully deleted <%= query.deleted_count %> images from IP <%= query.deleted_ip %>...!</div>
        <% } %>
        
        <div class="browse-controls">
            <h3>üîç Browse & Sort Images</h3>
            <form method="get" action="/admin">
                <div class="control-row">
                    <div class="control-group">
                        <label for="sort">Sort by:</label>
                        <select name="sort" id="sort">
                            <% sortOptions.forEach(option => { %>
                                <option value="<%= option.value %>" <%= sortBy === option.value ? 'selected' : '' %>>
                                    <%= option.label %>
                                </option>
                            <% }); %>
                        </select>
                    </div>
                    
                    <div class="control-group" id="orderGroup" style="<%= sortBy.startsWith('roll_') ? 'display: none;' : '' %>">
                        <label for="order">Order:</label>
                        <select name="order" id="order">
                            <option value="desc" <%= order === 'desc' ? 'selected' : '' %>>üîΩ Newest/Highest First</option>
                            <option value="asc" <%= order === 'asc' ? 'selected' : '' %>>üîº Oldest/Lowest First</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label for="search_id">Search ID:</label>
                        <input type="text" name="search_id" id="search_id" value="<%= searchId %>" 
                               placeholder="Enter image ID..." class="search-input">
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" name="show_hidden" id="show_hidden" value="true" <%= showHidden ? 'checked' : '' %>>
                        <label for="show_hidden">üï∂Ô∏è Show Hidden Images</label>
                    </div>
                    
                    <button type="submit" class="apply-btn">üîç Apply</button>
                    <a href="/admin" class="clear-btn">üßπ Clear All</a>
                </div>
                
                <% if (searchId || sortBy !== 'id' || order !== 'desc' || showHidden) { %>
                <div class="active-filters">
                    <strong>Active filters:</strong>
                    <% if (sortBy !== 'id') { %>
                        <span class="filter-tag">Sort: <%= sortOptions.find(opt => opt.value === sortBy).label %></span>
                    <% } %>
                    <% if (order !== 'desc' && !sortBy.startsWith('roll_')) { %>
                        <span class="filter-tag">Order: <%= order === 'asc' ? 'Ascending' : 'Descending' %></span>
                    <% } %>
                    <% if (searchId) { %>
                        <span class="filter-tag">ID Search: <%= searchId %></span>
                    <% } %>
                    <% if (showHidden) { %>
                        <span class="filter-tag">Including Hidden</span>
                    <% } %>
                </div>
                <% } %>
            </form>
        </div>
        
        <div class="stats">
            <h2>üìä Stats</h2>
            <div class="stats-grid">
                <div class="stat-box">
                    <h3>üñºÔ∏è Image Counts</h3>
                    <p>Total Images: <%= stats.total %></p>
                    <p>Visible Images: <%= stats.visible %></p>
                    <p>Hidden Images: <%= stats.hidden %></p>
                    <p>Showing <%= from %> - <%= to %> of <%= count %> 
                       <% if (searchId || sortBy !== 'id' || order !== 'desc' || showHidden) { %>
                           <em>(filtered)</em>
                       <% } %>
                    </p>
                </div>
                <div class="stat-box">
                    <h3>üé≤ Roll Stats</h3>
                    <p>‚ú® Lucky Survivors: <%= stats.luckySurvivor %></p>
                    <p>üí© Normal Shit: <%= stats.normalShit %></p>
                    <p>üíÄ Extreme Nuclear: <%= stats.extremeNuclear %></p>
                </div>
                <div class="stat-box">
                    <h3>üì¶ Storage</h3>
                    <p>Total Size: <%= (stats.totalSize / 1024 / 1024).toFixed(2) %> MB</p>
                    <p>Avg Size: <%= (stats.totalSize / stats.total / 1024).toFixed(2) %> KB per image</p>
                </div>
                <div class="stat-box">
                    <h3>üö´ Banned IPs</h3>
                    <p>Total Banned: <%= bannedIPsCount %></p>
                    <p><a href="/admin/banned-ips" style="color: #ff6b6b;">Manage Banned IPs ‚Üí</a></p>
                </div>
            </div>
            
            <div class="management-section">
                <h3>üõ†Ô∏è Image Management by ID</h3>
                <div class="form-row">
                    <input type="text" id="imageIdInput" placeholder="Paste image ID here" required class="form-input">
                    
                    <form action="/admin/delete-by-id" method="post" style="display: inline;">
                        <input type="hidden" name="imageId" id="deleteImageId">
                        <button type="submit" class="delete-btn" 
                                onclick="document.getElementById('deleteImageId').value = document.getElementById('imageIdInput').value; return confirm('Are you sure you want to delete this image?')">
                            üóëÔ∏è Delete
                        </button>
                    </form>
                    
                    <form action="/admin/toggle-visibility-by-id" method="post" style="display: inline;">
                        <input type="hidden" name="imageId" id="toggleImageId">
                        <button type="submit" class="visibility-btn visible" 
                                onclick="document.getElementById('toggleImageId').value = document.getElementById('imageIdInput').value; return confirm('Are you sure you want to toggle the visibility of this image?')">
                            üëÅÔ∏è Toggle Visibility
                        </button>
                    </form>
                    
                    <form action="/admin/ban-ip-by-id" method="post" style="display: inline;">
                        <input type="hidden" name="imageId" id="banImageId">
                        <button type="submit" class="ban-btn" 
                                onclick="document.getElementById('banImageId').value = document.getElementById('imageIdInput').value; return confirm('Are you sure you want to ban the IP associated with this image? This will prevent them from uploading any more images.')">
                            üö´ Ban IP
                        </button>
                    </form>
                </div>
            </div>

            <div class="bulk-delete-section">
                <h3>üíÄ NUCLEAR OPTION: Bulk Delete by IP Address</h3>
                <p class="warning-text">‚ö†Ô∏è <strong>DANGER ZONE:</strong> This will permanently delete ALL images uploaded by the specified IP address!</p>
                
                <div class="form-row">
                    <input type="text" id="bulkDeleteIpInput" placeholder="Paste IP hash here (e.g., a1b2c3d4...)" required class="form-input">
                    
                    <form action="/admin/delete-all-by-ip-input" method="post" style="display: inline;">
                        <input type="hidden" name="ipHash" id="bulkDeleteIpHash">
                        <button type="submit" class="bulk-delete-btn"
                                onclick="
                                    const ipHash = document.getElementById('bulkDeleteIpInput').value.trim();
                                    if (!ipHash) {
                                        alert('Please enter an IP hash');
                                        return false;
                                    }
                                    document.getElementById('bulkDeleteIpHash').value = ipHash;
                                    return confirm('‚ö†Ô∏è ARE YOU ABSOLUTELY SURE?\\n\\nThis will PERMANENTLY DELETE ALL IMAGES uploaded by IP: ' + ipHash.substring(0, 8) + '...\\n\\nThis action cannot be undone!');
                                ">
                            üíÄ DELETE ALL BY IP
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="image-list">
            <h2>üñºÔ∏è Images</h2>
            <table>
                <tr>
                    <th>Thumbnail</th>
                    <th>ID</th>
                    <th>Shitification</th>
                    <th>Date</th>
                    <th>IP Info</th>
                    <th>Country</th>
                    <th>Actions</th>
                </tr>
                <% images.forEach(img => { %>
                    <tr style="<%= img.isHidden ? 'opacity: 0.6; background-color: #f5f5f5;' : '' %>">
                        <td><img src="/raw/<%= img.id %>" class="thumbnail" loading="lazy" /></td>
                        <td>
                            <a href="/image/<%= img.id %>" target="_blank"><%= img.id %></a>
                            <% if (img.isHidden) { %><br><small style="color: #ff6b6b;">üï∂Ô∏è HIDDEN</small><% } %>
                        </td>
                        <td>
                            <span class="shitlevel-badge <%= img.shitLevelClass %>">
                                <%= img.shitLevel %> (<%= img.roll.toFixed(2) %>%)
                            </span>
                        </td>
                        <td><%= img.date %></td>
                        <td class="ip-info">
                            <%= img.hasIP ? img.ipHash : 'No IP tracked' %>
                        </td>
                        <td>
                            <%= img.hasIP ? img.country || 'Unknown' : 'No IP tracked' %>
                        </td>
                        <td>
                            <form action="/admin/toggle-visibility/<%= img.id %>" method="post" style="display:inline;">
                                <input type="hidden" name="currentState" value="<%= img.isHidden %>">
                                <button type="submit" class="visibility-btn <%= img.isHidden ? 'hidden' : 'visible' %>">
                                    <%= img.isHidden ? 'üëÅÔ∏è Show' : 'üï∂Ô∏è Hide' %>
                                </button>
                            </form>
                            <% if (img.hasIP) { %>
                                <form action="/admin/ban-ip/<%= img.id %>" method="post" style="display:inline;">
                                    <button type="submit" class="ban-btn" onclick="return confirm('Are you sure you want to ban this IP? This will prevent them from uploading any more images.')">
                                        üö´ Ban IP
                                    </button>
                                </form>
                                <form action="/admin/delete-all-by-image-ip/<%= img.id %>" method="post" style="display:inline;">
                                    <button type="submit" class="delete-btn nuclear" 
                                            onclick="return confirm('‚ö†Ô∏è NUCLEAR OPTION ‚ö†Ô∏è\\n\\nThis will DELETE ALL IMAGES ever uploaded by this IP address!\\n\\nThis includes image <%= img.id %> and potentially many others.\\n\\nThis action CANNOT be undone!\\n\\nAre you absolutely sure?')">
                                        üíÄ DELETE ALL BY THIS IP
                                    </button>
                                </form>
                            <% } else { %>
                                <button class="ban-btn" disabled>üö´ No IP</button>
                                <button class="delete-btn" disabled style="opacity: 0.5;">üíÄ No IP</button>
                            <% } %>
                            <form action="/admin/delete/<%= img.id %>" method="post" style="display:inline;">
                                <button type="submit" class="delete-btn" onclick="return confirm('Are you sure you want to delete this image?')">üóëÔ∏è Delete</button>
                            </form>
                        </td>
                    </tr>
                <% }); %>
            </table>

            <div class="pagination">
                <%
                const baseUrl = `/admin?sort=${sortBy}&order=${order}${searchId ? `&search_id=${encodeURIComponent(searchId)}` : ''}${showHidden ? '&show_hidden=true' : ''}`;
                %>
                
                <% if (page > 1) { %>
                    <a href="<%= baseUrl %>&page=<%= page - 1 %>">‚¨ÖÔ∏è Previous</a>
                <% } else { %>
                    <a class="disabled">‚¨ÖÔ∏è Previous</a>
                <% } %>
                
                <% 
                const startPage = Math.max(1, page - 2);
                const endPage = Math.min(totalPages, page + 2);
                for (let i = startPage; i <= endPage; i++) { %>
                    <a href="<%= baseUrl %>&page=<%= i %>" class="<%= i === page ? 'current' : '' %>"><%= i %></a>
                <% } %>
                
                <% if (page < totalPages) { %>
                    <a href="<%= baseUrl %>&page=<%= page + 1 %>">Next ‚û°Ô∏è</a>
                <% } else { %>
                    <a class="disabled">Next ‚û°Ô∏è</a>
                <% } %>
            </div>
        </div>
        
        <script>
            // Hide/show order dropdown based on sort selection
            document.getElementById('sort').addEventListener('change', function() {
                const orderGroup = document.getElementById('orderGroup');
                const sortValue = this.value;
                
                if (sortValue.startsWith('roll_')) {
                    orderGroup.style.display = 'none';
                } else {
                    orderGroup.style.display = 'flex';
                }
            });
        </script>
    </body>
</html>